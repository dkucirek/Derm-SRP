```{r}
install.packages("cards")
install.packages("cardx")
library(gtsummary)
library(dplyr)
library(stringr)
library(data.table)
library(cards)
library(cardx)


# --- Configuration: Set your data path here ---
# IMPORTANT: Change this path to the folder where your processed .rds files are saved.
data_path <- "Z:/Kucirek/"

# --- Step 1: Load Pre-processed Data ---
result_wide_derm_clean <- readRDS(file.path(data_path, "result_wide_derm_clean.rds"))
result_info <- readRDS(file.path(data_path, "result_info.rds"))

# Ensure they are data.tables
setDT(result_wide_derm_clean)
setDT(result_info)

# --- DIAGNOSTIC: Check result_info immediately after loading ---
print("--- Diagnostic: result_info after loading in derm_phq_screening_by_demographics.R ---")
print(summary(result_info$age_at_encounter))
print(class(result_info$age_at_encounter))
print(summary(result_info$fin_class))
print(class(result_info$fin_class))
print(head(result_info))

# --- Step 2: Prepare Patient-Level Screening Data (data.table version) ---

# Join encounter data with demographics
derm_with_demo <- merge(result_wide_derm_clean, result_info, by = "mrn_deid", all.x = TRUE)

# Calculate patient-level screening flags first
patient_screening_flags <- derm_with_demo[, .(
    ever_had_phq2_screen = any(
      !is.na(`phq_value_num_PHQ-2 score`) |
      !is.na(`phq_value_CMS PHQ-2 POS/NEG`) |
      !is.na(phq2_manual_sum),
      na.rm = TRUE
    ),
    ever_had_phq9_screen = any(
      !is.na(`phq_value_num_PHQ-9 Total Score`) |
      !is.na(`phq_value_CMS PHQ-9 POS/NEG`) |
      !is.na(phq9_manual_sum),
      na.rm = TRUE
    )
  ), by = mrn_deid]

# Start patient_screening_summary with unique patient demographics from result_info
patient_screening_summary <- unique(result_info, by = "mrn_deid")

# Now merge the screening flags into the patient_screening_summary
patient_screening_summary <- merge(patient_screening_summary, patient_screening_flags, by = "mrn_deid", all.x = TRUE)

# --- IMPORTANT OPTIMIZATION: Convert relevant columns to factors ---
# This helps gtsummary optimize its internal calculations, especially for p-values.
patient_screening_summary[, `:=` (
  sex = as.factor(sex),
  race_refined = as.factor(race_refined),
  ethnic_refined = as.factor(ethnic_refined),
  fin_class = as.factor(fin_class),
  ever_had_phq2_screen = as.factor(ever_had_phq2_screen),
  ever_had_phq9_screen = as.factor(ever_had_phq9_screen)
)]


# --- Step 3: Create Separate Tables for Each Demographic Variable ---

# Define a function to create and print tables for a given demographic variable
create_and_print_demographic_table <- function(data, demographic_var, var_label) {
  
  # PHQ-2 Screening Rates by Demographic
  table_phq2 <- data %>%
    select(!!sym(demographic_var), ever_had_phq2_screen) %>% # Use select from dplyr
    tbl_summary(
      by = ever_had_phq2_screen,
      label = list(!!sym(demographic_var) ~ var_label),
      statistic = list(all_categorical() ~ "{n} / {N} ({p}%)"),
      missing = "no"
    ) %>%
    add_p() %>%
    modify_column_hide(columns = stat_2) %>%
    modify_header(stat_1 ~ "**PHQ-2 Screened**")
  
  # PHQ-9 Screening Rates by Demographic
  table_phq9 <- data %>%
    select(!!sym(demographic_var), ever_had_phq9_screen) %>% # Use select from dplyr
    tbl_summary(
      by = ever_had_phq9_screen,
      label = list(!!sym(demographic_var) ~ var_label),
      statistic = list(all_categorical() ~ "{n} / {N} ({p}%)"),
      missing = "no"
    ) %>%
    add_p() %>%
    modify_column_hide(columns = stat_2) %>%
    modify_header(stat_1 ~ "**PHQ-9 Screened**")
  
  # Merge and print
  final_table <- tbl_merge(
    tbls = list(table_phq2, table_phq9),
    tab_spanner = c("**PHQ-2 Screening**", "**PHQ-9 Screening**")
  ) %>%
    modify_caption(paste0("**Depression Screening Rates in Dermatology by ", var_label, "**"))
  
  print(final_table)
  cat("\n\n") # Add some space between tables
}

# Generate tables for each categorical demographic variable
create_and_print_demographic_table(patient_screening_summary, "sex", "Sex")
create_and_print_demographic_table(patient_screening_summary, "race_refined", "Race")
create_and_print_demographic_table(patient_screening_summary, "ethnic_refined", "Ethnicity")
create_and_print_demographic_table(patient_screening_summary, "fin_class", "Insurance Class")

# For age, we need to handle it as a continuous variable for summary stats.
# PHQ-2 Screening Rates by Age (Continuous)
table_phq2_age <- patient_screening_summary %>%
  select(age_at_encounter, ever_had_phq2_screen) %>% # Use select from dplyr
  tbl_summary(
    by = ever_had_phq2_screen,
    label = list(age_at_encounter ~ "Age at First Encounter"),
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    missing = "no"
  ) %>%
  add_p() %>%
  modify_column_hide(columns = stat_2) %>%
  modify_header(stat_1 ~ "**PHQ-2 Screened**")

# PHQ-9 Screening Rates by Age (Continuous)
table_phq9_age <- patient_screening_summary %>%
  select(age_at_encounter, ever_had_phq9_screen) %>% # Use select from dplyr
  tbl_summary(
    by = ever_had_phq9_screen,
    label = list(age_at_encounter ~ "Age at First Encounter"),
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    missing = "no"
  ) %>%
  add_p() %>%
  modify_column_hide(columns = stat_2) %>%
  modify_header(stat_1 ~ "**PHQ-9 Screened**")

# Merge and print Age table
final_table_age <- tbl_merge(
  tbls = list(table_phq2_age, table_phq9_age),
  tab_spanner = c("**PHQ-2 Screening**", "**PHQ-9 Screening**")
) %>%
  modify_caption("**Depression Screening Rates in Dermatology by Age**")

print(final_table_age)

# To save these tables, you would use gtsave() for each one, e.g.:
# gtsave(final_table_sex, "derm_screening_by_sex.html")
# gtsave(final_table_race, "derm_screening_by_race.html")
# ... and so on for each table
```



